<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="{% static 'css/admin.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div class="container-fluid">
        <h1 class="mt-4">üë• –ü–∞–Ω–µ–ª—å –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h1>

        <!-- –ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω–æ–µ –º–µ–Ω—é -->
        <nav class="nav nav-pills flex-column flex-sm-row mb-4">
            <a class="flex-sm-fill text-sm-center nav-link {% if section == 'broadcast' %}active{% endif %}" href="{% url 'broadcast' %}"><i class="fas fa-paper-plane"></i> –°–¥–µ–ª–∞—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É</a>
            <a class="flex-sm-fill text-sm-center nav-link {% if section == 'manage_users' %}active{% endif %}" href="{% url 'manage_users' %}"><i class="fas fa-users"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</a>
            <a class="flex-sm-fill text-sm-center nav-link {% if section == 'statistics' %}active{% endif %}" href="{% url 'statistics' %}"><i class="fas fa-chart-line"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</a>
            <a class="flex-sm-fill text-sm-center nav-link {% if section == 'support_panel' %}active{% endif %}" href="{% url 'support_panel' %}"><i class="fas fa-headset"></i> –ü–∞–Ω–µ–ª—å –ø–æ–¥–¥–µ—Ä–∂–∫–∏</a>
        </nav>

        <!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞ -->
        {% if section == 'broadcast' %}
        <!-- –†–∞–∑–¥–µ–ª –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏ -->
        <div class="card mb-3">
            <div class="card-header">
                <h2>üì¢ –°–¥–µ–ª–∞—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É</h2>
            </div>
            <div class="card-body">
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="message" class="form-label">–°–æ–æ–±—â–µ–Ω–∏–µ</label>
                        <textarea class="form-control" id="message" name="message" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="image" class="form-label">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                        <input class="form-control" type="file" id="image" name="image">
                    </div>
                    {% if status %}
                        <div class="alert alert-success">{{ status }}</div>
                    {% endif %}
                    <button type="submit" class="btn btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                </form>
            </div>
        </div>

        {% elif section == 'manage_users' %}
        <!-- –†–∞–∑–¥–µ–ª –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ -->
        <div class="card mb-3">
            <div class="card-header">
                <h2>üë§ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h2>
            </div>
            <div class="card-body">
                <input class="form-control mb-3" id="searchUserInput" type="text" placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
                <ul class="list-group" id="userList">  
                    {% for user in users %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>{{ user.username }}</strong> (ID: {{ user.user_id }})
                        </div>
                        <div>
                            <!-- –ü–æ–¥–ø–∏—Å–∫–∞ -->
                            <form method="post" style="display:inline;">
                                {% csrf_token %}
                                <input type="hidden" name="user_id" value="{{ user.user_id }}">
                                {% if user.subscription_type == 'FREE' %}
                                    <button class="btn btn-sm btn-outline-primary" name="action" value="add_subscription">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É</button>
                                {% else %}
                                    <button class="btn btn-sm btn-outline-danger" name="action" value="remove">–£–¥–∞–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É</button>
                                {% endif %}
                            </form>

                            <!-- –°–æ—Å—Ç–æ—è–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞ -->
                            <form method="post" style="display:inline;">
                                {% csrf_token %}
                                <input type="hidden" name="user_id" value="{{ user.user_id }}">
                                {% if user.is_blocked %}
                                    <button class="btn btn-sm btn-outline-success" name="action" value="unblock">–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>
                                {% else %}
                                    <button class="btn btn-sm btn-outline-warning" name="action" value="block">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>
                                {% endif %}
                            </form>
                        </div>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>

        {% elif section == 'statistics' %}
        <!-- –†–∞–∑–¥–µ–ª –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
        <div class="card mb-3">
            <div class="card-header">
                <h2>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
            </div>
            <div class="card-body">
                <canvas id="subscribersChart"></canvas>
            </div>
        </div>

        {% elif section == 'support_panel' %}
        <!-- –ü–∞–Ω–µ–ª—å –ø–æ–¥–¥–µ—Ä–∂–∫–∏ -->
        <div class="card mb-3">
            <div class="card-header">
                <h2>üí¨ –ü–∞–Ω–µ–ª—å –ø–æ–¥–¥–µ—Ä–∂–∫–∏</h2>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <h4>–¢–∏–∫–µ—Ç—ã</h4>
                        <div class="list-group">
                            {% for ticket in tickets %}
                                <div class="list-group-item">
                                    <h5 class="mb-1">–¢–∏–∫–µ—Ç #{{ ticket.ticket_id }}</h5>
                                    <p class="mb-1">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {{ ticket.user.username }}</p>
                                    <p class="mb-1">–í–æ–ø—Ä–æ—Å: {{ ticket.question }}</p>
                                    <p class="mb-1">–°—Ç–∞—Ç—É—Å: {{ ticket.status }}</p>
                                    <p class="mb-1">–°–æ–∑–¥–∞–Ω: {{ ticket.created_at }}</p>

                                    {% if ticket.status != 'closed' %}
                                        <form method="post" class="d-inline">
                                            {% csrf_token %}
                                            <input type="hidden" name="ticket_id" value="{{ ticket.ticket_id }}">
                                            <button type="submit" name="action" value="close" class="btn btn-danger">–ó–∞–∫—Ä—ã—Ç—å —Ç–∏–∫–µ—Ç</button>
                                        </form>
                                        <form method="post" class="d-inline">
                                            {% csrf_token %}
                                            <input type="hidden" name="ticket_id" value="{{ ticket.ticket_id }}">
                                            <input type="text" name="assigned_user" placeholder="ID –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞" required>
                                            <button type="submit" name="action" value="assign" class="btn btn-success">–ù–∞–∑–Ω–∞—á–∏—Ç—å –æ–ø–µ—Ä–∞—Ç–æ—Ä—É</button>
                                        </form>
                                    {% endif %}
                                </div>
                            {% empty %}
                                <div class="list-group-item">–ù–µ—Ç –Ω–æ–≤—ã—Ö —Ç–∏–∫–µ—Ç–æ–≤.</div>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="col-md-4">
                        <h4>–î–æ—Å—Ç—É–ø–Ω—ã–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã</h4>
                        <ul class="list-group mt-3">
                            {% for operator in operators %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>{{ operator.user.username }}</strong>
                                    </div>
                                    <span class="badge {% if operator.is_active %}bg-success{% else %}bg-danger{% endif %}">
                                        {% if operator.is_active %}
                                            Online
                                        {% else %}
                                            Offline
                                        {% endif %}
                                    </span>
                                </li>
                            {% empty %}
                                <li class="list-group-item">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤.</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        {% endif %}
    </div>

    <!-- –°–∫—Ä–∏–ø—Ç –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –≥—Ä–∞—Ñ–∏–∫–∞ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ -->
    {% if section == 'statistics' %}
    <script>
        const ctx = document.getElementById('subscribersChart').getContext('2d');
        const subscribersChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: {{ statistics.labels | safe }},
                datasets: [
                    {
                        label: '–ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏',
                        data: {{ statistics.new_subscribers_data | safe }},
                        backgroundColor: 'rgba(75, 192, 192, 0.5)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1,
                    },
                    {
                        label: '–ü—Ä–µ–º–∏—É–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏',
                        data: {{ statistics.premium_users_data | safe }},
                        backgroundColor: 'rgba(255, 205, 86, 0.5)',
                        borderColor: 'rgba(255, 205, 86, 1)',
                        borderWidth: 1,
                    },
                    {
                        label: '–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å—Å—ã–ª–∫–∏',
                        data: {{ statistics.link_data | safe }},
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 2,
                        fill: false,
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –ø—Ä–µ–º–∏—É–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å—Å—ã–ª–æ–∫ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    </script>
    {% endif %}
    <script src="{% static 'js/admin.js' %}"></script>
</body>
</html>
