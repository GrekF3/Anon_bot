<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="{% static 'css/admin.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css">
<script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>
</head>
<body>
    <div class="container-fluid">
        <h1 class="mt-4">üë• –ü–∞–Ω–µ–ª—å –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h1>

        <nav class="nav nav-pills flex-column flex-sm-row mb-4">
            {% if user.is_superuser %}
                <a class="flex-sm-fill text-sm-center nav-link {% if section == 'broadcast' %}active{% endif %}" href="{% url 'broadcast' %}"><i class="fas fa-paper-plane"></i> –°–¥–µ–ª–∞—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É</a>
                <a class="flex-sm-fill text-sm-center nav-link {% if section == 'manage_users' %}active{% endif %}" href="{% url 'manage_users' %}"><i class="fas fa-users"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</a>
            {% endif %}
            <a class="flex-sm-fill text-sm-center nav-link {% if section == 'support_panel' %}active{% endif %}" href="{% url 'support_panel' %}"><i class="fas fa-headset"></i> –ü–∞–Ω–µ–ª—å –ø–æ–¥–¥–µ—Ä–∂–∫–∏</a>
        </nav>

        {% if section == 'broadcast' %}
        <!-- –†–∞–∑–¥–µ–ª –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏ -->
        {% if user.is_superuser %}
            <div class="card mb-3">
                <div class="card-header">
                    <h2>üì¢ –°–¥–µ–ª–∞—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É</h2>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="message" class="form-label">–°–æ–æ–±—â–µ–Ω–∏–µ</label>
                            <!-- Markdown Editor (SimpleMDE) -->
                            <textarea id="message" name="message" rows="10"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="image" class="form-label">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                            <input class="form-control" type="file" id="image" name="image">
                        </div>
                        {% if status %}
                            <div class="alert alert-success">{{ status }}</div>
                        {% endif %}
                        <button type="submit" class="btn btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                    </form>
                </div>
            </div>
            <script>
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è SimpleMDE
                var simplemde = new SimpleMDE({ element: document.getElementById("message") });

                // –ü—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–æ—Ä–º—ã —Å–æ—Ö—Ä–∞–Ω—è–µ–º Markdown –≤ —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
                document.querySelector("form").onsubmit = function() {
                    document.getElementById("message").value = simplemde.value();
                };
            </script>
        {% else %}
            <h2>–£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–º—É —Ä–∞–∑–¥–µ–ª—É</h2>
        {% endif %}
        {% elif section == 'manage_users' %}
        <!-- –†–∞–∑–¥–µ–ª –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ -->
        {% if user.is_superuser %}
        <div class="card mb-3">
            <div class="card-header">
                <h2>üë§ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h2>
            </div>
            <div class="card-body">
                <p>–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: <strong>{{ total_users }}</strong></p>
                <input class="form-control mb-3" id="searchUserInput" type="text" placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
                <ul class="list-group" id="userList">
                    {% for user in users %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>{{ user.username }}</strong> (ID: {{ user.user_id }})
                        </div>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        {% else %}
            <h2>–£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–º—É —Ä–∞–∑–¥–µ–ª—É</h2>
        {% endif %}
        {% elif section == 'support_panel' %}
        <!-- –ü–∞–Ω–µ–ª—å –ø–æ–¥–¥–µ—Ä–∂–∫–∏ -->
        <div class="card mb-3">
            <div class="card-header">
                <h2>üí¨ –ü–∞–Ω–µ–ª—å –ø–æ–¥–¥–µ—Ä–∂–∫–∏</h2>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <h4>–¢–∏–∫–µ—Ç—ã</h4>

                        <h5>–û—Ç–∫—Ä—ã—Ç—ã–µ —Ç–∏–∫–µ—Ç—ã</h5>
                        <div class="list-group">
                            {% for ticket in open_tickets %}
                                <div class="list-group-item">
                                    <h5 class="mb-1">–¢–∏–∫–µ—Ç #{{ ticket.ticket_id }}</h5>
                                    <p class="mb-1">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {{ ticket.user.username }}</p>
                                    <p class="mb-1">–í–æ–ø—Ä–æ—Å: {{ ticket.question }}</p>
                                    <p class="mb-1">–°—Ç–∞—Ç—É—Å: {{ ticket.status }}</p>
                                    <p class="mb-1">–°–æ–∑–¥–∞–Ω: {{ ticket.created_at }}</p>

                                    <form method="post" class="d-inline">
                                        {% csrf_token %}
                                        <input type="hidden" name="ticket_id" value="{{ ticket.ticket_id }}">
                                        <button type="submit" name="action" value="close" class="btn btn-danger">–ó–∞–∫—Ä—ã—Ç—å —Ç–∏–∫–µ—Ç</button>
                                    </form>
                                    <form method="post" class="d-inline">
                                        {% csrf_token %}
                                        <input type="hidden" name="ticket_id" value="{{ ticket.ticket_id }}">
                                        <input type="text" name="assigned_user" placeholder="ID –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞" required>
                                        <button type="submit" name="action" value="assign" class="btn btn-success">–ù–∞–∑–Ω–∞—á–∏—Ç—å –æ–ø–µ—Ä–∞—Ç–æ—Ä—É</button>
                                    </form>
                                    <a href="{% url 'ticket_chat' ticket.ticket_id %}" class="btn btn-info">–ß–∞—Ç</a>
                                </div>
                            {% empty %}
                                <div class="list-group-item">–ù–µ—Ç –æ—Ç–∫—Ä—ã—Ç—ã—Ö —Ç–∏–∫–µ—Ç–æ–≤.</div>
                            {% endfor %}
                        </div>

                        <h5 class="mt-4">–¢–∏–∫–µ—Ç—ã –≤ —Ä–∞–±–æ—Ç–µ</h5>
                        <div class="list-group">
                            {% for ticket in in_progress_tickets %}
                                <div class="list-group-item">
                                    <h5 class="mb-1">–¢–∏–∫–µ—Ç #{{ ticket.ticket_id }}</h5>
                                    <p class="mb-1">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {{ ticket.user.username }}</p>
                                    <p class="mb-1">–í–æ–ø—Ä–æ—Å: {{ ticket.question }}</p>
                                    <p class="mb-1">–°—Ç–∞—Ç—É—Å: {{ ticket.status }}</p>
                                    <p class="mb-1">–°–æ–∑–¥–∞–Ω: {{ ticket.created_at }}</p>
                                    <p class="mb-1">–ù–∞–∑–Ω–∞—á–µ–Ω –æ–ø–µ—Ä–∞—Ç–æ—Ä—É: {{ ticket.assigned_user.username }}</p>
                                    <form method="post" class="d-inline">
                                        {% csrf_token %}
                                        <input type="hidden" name="ticket_id" value="{{ ticket.ticket_id }}">
                                        <button type="submit" name="action" value="close" class="btn btn-danger">–ó–∞–∫—Ä—ã—Ç—å —Ç–∏–∫–µ—Ç</button>
                                    </form>
                                    <a href="{% url 'ticket_chat' ticket.ticket_id %}" class="btn btn-info">–ß–∞—Ç</a>
                                </div>
                            {% empty %}
                                <div class="list-group-item">–ù–µ—Ç —Ç–∏–∫–µ—Ç–æ–≤ –≤ —Ä–∞–±–æ—Ç–µ.</div>
                            {% endfor %}
                        </div>

                        <h5 class="mt-4">–ó–∞–∫—Ä—ã—Ç—ã–µ —Ç–∏–∫–µ—Ç—ã</h5>
                        <div class="list-group">
                            {% for ticket in closed_tickets %}
                                <div class="list-group-item">
                                    <h5 class="mb-1">–¢–∏–∫–µ—Ç #{{ ticket.ticket_id }}</h5>
                                    <p class="mb-1">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {{ ticket.user.username }}</p>
                                    <p class="mb-1">–í–æ–ø—Ä–æ—Å: {{ ticket.question }}</p>
                                    <p class="mb-1">–°—Ç–∞—Ç—É—Å: {{ ticket.status }}</p>
                                    <p class="mb-1">–°–æ–∑–¥–∞–Ω: {{ ticket.created_at }}</p>
                                </div>
                            {% empty %}
                                <div class="list-group-item">–ù–µ—Ç –∑–∞–∫—Ä—ã—Ç—ã—Ö —Ç–∏–∫–µ—Ç–æ–≤.</div>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="col-md-4">
                        <h4>–î–æ—Å—Ç—É–ø–Ω—ã–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã</h4>
                        <ul class="list-group mt-3">
                            {% for operator in operators %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>{{ operator.user.username }} ({{operator.user.user_id}})</strong>
                                    </div>
                                    <span class="badge {% if operator.is_active %}bg-success{% else %}bg-danger{% endif %}">
                                        {% if operator.is_active %}
                                            Online
                                        {% else %}
                                            Offline
                                        {% endif %}
                                    </span>
                                </li>
                            {% empty %}
                                <li class="list-group-item">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤.</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <script src="{% static 'js/admin.js' %}"></script>
</body>
</html>
